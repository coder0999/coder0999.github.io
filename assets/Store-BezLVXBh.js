import{r,j as e,u as S,b as q,c as j,q as M,o as P,a as C,d as x,e as k,s as E,f as A,g as D}from"./index-BMM5eybz.js";const I=({isOpen:a,onClose:u,product:c,onSubmit:m})=>{const[l,d]=r.useState("whatsapp"),[n,h]=r.useState("");if(!a)return null;const i=t=>{if(t.preventDefault(),!n){alert("يرجى إدخال رقم الهاتف");return}m({contactMethod:l,phoneNumber:n})};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50",children:e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-xl w-full max-w-md mx-4",children:[e.jsxs("h2",{className:"text-2xl font-bold mb-4 text-right",children:["شراء ",c.name]}),e.jsxs("p",{className:"mb-6 text-right",children:["سعر المنتج: ",c.price," نقاط"]}),e.jsxs("form",{onSubmit:i,children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-right mb-2 font-bold",children:"طريقة التواصل"}),e.jsxs("div",{className:"flex justify-end gap-4",children:[e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("span",{children:"Telegram"}),e.jsx("input",{type:"radio",name:"contactMethod",value:"telegram",checked:l==="telegram",onChange:t=>d(t.target.value),className:"form-radio"})]}),e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("span",{children:"WhatsApp"}),e.jsx("input",{type:"radio",name:"contactMethod",value:"whatsapp",checked:l==="whatsapp",onChange:t=>d(t.target.value),className:"form-radio"})]})]})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{htmlFor:"phoneNumber",className:"block text-right mb-2 font-bold",children:"رقم الهاتف"}),e.jsx("input",{type:"tel",id:"phoneNumber",value:n,onChange:t=>h(t.target.value),className:"w-full p-2 border border-gray-300 rounded-lg text-right",placeholder:"مثال: 966512345678+",required:!0})]}),e.jsxs("div",{className:"flex justify-end gap-4",children:[e.jsx("button",{type:"button",onClick:u,className:"bg-gray-500 text-white font-bold py-2 px-4 rounded-lg",children:"إلغاء"}),e.jsx("button",{type:"submit",className:"bg-blue-600 text-white font-bold py-2 px-4 rounded-lg",children:"إرسال الطلب"})]})]})]})})},R=()=>{const{user:a}=S(),{points:u,loading:c}=q(),[m,l]=r.useState([]),[d,n]=r.useState(!0),[h,i]=r.useState(!1),[t,g]=r.useState(null);r.useEffect(()=>{const s=j(x,"products"),o=M(s,P("createdAt","desc")),v=C(o,p=>{const w=p.docs.map(f=>({id:f.id,...f.data()}));l(w),n(!1)},p=>{console.error("Error fetching products:",p),n(!1)});return()=>v()},[]);const N=s=>{if(s.quantity<=0){alert("نفدت الكمية من هذا المنتج.");return}u<s.price?alert("ليس لديك نقاط كافية"):(g(s),i(!0))},b=()=>{i(!1),g(null)},y=async s=>{if(!(!a||!t))try{await k(j(x,"orders"),{userId:a.uid,userEmail:a.email,productId:t.id,productName:t.name,productPrice:t.price,contactMethod:s.contactMethod,phoneNumber:s.phoneNumber,status:"pending",createdAt:E()});const o=A(x,"products",t.id);await D(o,{quantity:t.quantity-1}),alert("تم إرسال طلبك بنجاح!")}catch(o){console.error("Error creating order or updating quantity:",o),alert("حدث خطأ أثناء إرسال طلبك.")}finally{b()}};return c||d?e.jsx("div",{className:"container mx-auto p-4 flex-grow flex justify-center items-center",children:e.jsx("div",{className:"spinner"})}):e.jsxs("div",{className:"container mx-auto p-4 flex-grow",children:[!a&&e.jsxs("div",{className:"bg-orange-100 border-l-4 border-orange-500 text-orange-700 p-4 mb-6",role:"alert",children:[e.jsx("p",{className:"font-bold",children:"ملاحظة:"}),e.jsx("p",{children:"لن تتمكن من الشراء الا عند تسجيل الدخول من صفحة البروفايل."})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-10",children:m.map(s=>e.jsxs("div",{className:`bg-white rounded-lg shadow-md p-4 transition-transform 
                        ${a?"cursor-pointer hover:scale-105":"opacity-50 cursor-not-allowed pointer-events-none"}`,onClick:()=>N(s),children:[e.jsx("h3",{className:"text-xl font-bold mb-2",children:s.name}),e.jsxs("p",{className:"text-gray-700 text-lg mb-2",children:[s.price," نقطة"]}),s.quantity>0?e.jsxs("p",{className:"text-gray-500 text-sm",children:["الكمية المتاحة: ",s.quantity]}):e.jsx("p",{className:"text-red-500 font-bold text-sm",children:"نفدت الكمية"})]},s.id))}),t&&e.jsx(I,{isOpen:h,onClose:b,product:t,onSubmit:y})]})};export{R as default};
